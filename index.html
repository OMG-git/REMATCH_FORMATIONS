<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5v5 サッカーフォーメーション</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --body-bg: #f0f4f8;
            --text-color: #1f2937; /* Tailwind gray-800 */
            --instructions-bg: white;
            --instructions-text-color: #555;
            --instructions-heading-color: #333;
            --field-bg: #4CAF50;
            --field-border-color: #FFF;
            --line-color: #FFF;
            --goal-bg: #DDD;
            --goal-border: #AAA;
            --player-red-bg: #EF4444;
            --player-blue-bg: #3B82F6;
            --player-red-gk-bg: #DC2626;
            --player-blue-gk-bg: #1D4ED8;
            --gk-border-color: #FDE047; /* Tailwind yellow-300 */
            --ball-bg: #FFFFFF;
            --ball-border: #000000;
            --button-bg: #e5e7eb; /* Tailwind gray-200 */
            --button-text: #1f2937; /* Tailwind gray-800 */
            --button-hover-bg: #d1d5db; /* Tailwind gray-300 */
        }

        body.dark-mode {
            --body-bg: #111827; /* Tailwind gray-900 */
            --text-color: #f3f4f6; /* Tailwind gray-100 */
            --instructions-bg: #1f2937; /* Tailwind gray-800 */
            --instructions-text-color: #d1d5db; /* Tailwind gray-300 */
            --instructions-heading-color: #e5e7eb; /* Tailwind gray-200 */
            --field-bg: #388E3C; /* 暗めの緑 */
            --field-border-color: #4b5563; /* Tailwind gray-600 */
            --line-color: #9ca3af; /* Tailwind gray-400 */
            --goal-bg: #4b5563; /* Tailwind gray-600 */
            --goal-border: #6b7280; /* Tailwind gray-500 */
            --player-red-bg: #B91C1C; /* Tailwind red-700 */
            --player-blue-bg: #1E40AF; /* Tailwind blue-700 */
            --player-red-gk-bg: #991B1B; /* Tailwind red-800 */
            --player-blue-gk-bg: #1E3A8A; /* Tailwind blue-800 */
            /* --gk-border-color は変更なしでも目立つ */
            --ball-bg: #e5e7eb; /* Tailwind gray-200 */
            --ball-border: #9ca3af; /* Tailwind gray-400 */
            --button-bg: #374151; /* Tailwind gray-700 */
            --button-text: #f3f4f6; /* Tailwind gray-100 */
            --button-hover-bg: #4b5563; /* Tailwind gray-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* 縦並びにする */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--body-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        .soccer-field {
            position: relative;
            width: 700px;
            height: 450px;
            background-color: var(--field-bg);
            border: 2px solid var(--field-border-color);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .line { 
            position: absolute; 
            background-color: var(--line-color); 
            opacity: 0.7; 
            transition: background-color 0.3s;
        }
        .center-line { width: 2px; height: 100%; left: 50%; top: 0; transform: translateX(-50%); }
        .center-circle { width: 90px; height: 90px; border: 2px solid var(--line-color); opacity: 0.7; border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%, -50%); transition: border-color 0.3s;}
        .center-spot { width: 5px; height: 5px; background-color: var(--line-color); border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%, -50%); transition: background-color 0.3s;}
        
        .penalty-area {
            position: absolute;
            width: 81px; 
            height: 308px; 
            border: 2px solid var(--line-color);
            opacity: 0.7;
            top: 50%;
            transform: translateY(-50%);
            transition: border-color 0.3s;
        }
        .penalty-area.left { left: 0; }
        .penalty-area.right { right: 0; }

        .goal-area {
            position: absolute;
            width: 27px; 
            height: 140px; 
            border: 2px solid var(--line-color);
            opacity: 0.7;
            top: 50%;
            transform: translateY(-50%);
            transition: border-color 0.3s;
        }
        .goal-area.left { left: 0; }
        .goal-area.right { right: 0; }

        .goal {
            position: absolute;
            width: 10px; 
            height: 90px; 
            background-color: var(--goal-bg); 
            border: 2px solid var(--goal-border);
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .goal.left { left: -10px; } 
        .goal.right { right: -10px; }

        .player {
            position: absolute;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            cursor: grab;
            user-select: none;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        .player.dragging {
            cursor: grabbing;
            z-index: 100;
            opacity: 0.8;
        }

        .player.red { background-color: var(--player-red-bg); }
        .player.blue { background-color: var(--player-blue-bg); }

        .player.red.goalkeeper {
            background-color: var(--player-red-gk-bg);
            border: 3px solid var(--gk-border-color);
            box-shadow: 0 0 10px var(--gk-border-color);
        }
        .player.blue.goalkeeper {
            background-color: var(--player-blue-gk-bg);
            border: 3px solid var(--gk-border-color);
            box-shadow: 0 0 10px var(--gk-border-color);
        }

        .ball {
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: var(--ball-bg);
            border: 2px solid var(--ball-border);
            border-radius: 50%;
            cursor: grab;
            z-index: 5; /* プレイヤーより手前だが、ドラッグ中のプレイヤーよりは奥 */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .ball.dragging {
            cursor: grabbing;
            z-index: 99; /* ドラッグ中のプレイヤーよりは奥 */
            opacity: 0.8;
        }

        .controls {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        #darkModeToggle {
            padding: 8px 16px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        #darkModeToggle:hover {
            background-color: var(--button-hover-bg);
        }

        .instructions {
            margin-top: 10px; /* 少しマージン調整 */
            padding: 15px;
            background-color: var(--instructions-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: left;
            max-width: 700px;
            transition: background-color 0.3s;
        }
        .instructions h3 {
            font-size: 1.2em;
            color: var(--instructions-heading-color);
            margin-bottom: 10px;
            transition: color 0.3s;
        }
        .instructions p, .instructions ul {
            font-size: 0.9em;
            color: var(--instructions-text-color);
            line-height: 1.6;
            transition: color 0.3s;
        }
        .instructions ul {
            list-style-type: disc;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="darkModeToggle">ライト/ダーク モード切替</button>
    </div>
    <div class="soccer-field" id="soccerField">
        <div class="line center-line"></div>
        <div class="line center-circle"></div>
        <div class="line center-spot"></div>
        <div class="penalty-area left" id="redPenaltyArea"></div>
        <div class="penalty-area right" id="bluePenaltyArea"></div>
        <div class="goal-area left"></div>
        <div class="goal-area right"></div>
        <div class="goal left"></div>
        <div class="goal right"></div>
        <div id="ball" class="ball"></div>
        </div>
    <div class="instructions">
        <h3>操作方法とルール</h3>
        <p>各プレイヤー（円）とボール（白い円）をマウスでドラッグして、フィールド上の好きな位置に配置できます。</p>
        <ul>
            <li><strong>ゴールキーパー (GK):</strong> 黄色い枠で強調表示されているプレイヤーがGKです。</li>
            <li>自陣ペナルティエリア（ゴール前の長方形エリア）内に味方プレイヤーが1人だけいる場合、そのプレイヤーがGKになります。</li>
            <li>GKがペナルティエリアから出るとGKではなくなります。</li>
            <li>ペナルティエリア内に味方プレイヤーが複数いる場合、その中の1人のみがGKとして扱われます。</li>
            <li>現在のGKがペナルティエリアから出て、エリア内に他の味方プレイヤーが残っている場合、残っているプレイヤーの中からランダムに1人が新しいGKになります。</li>
        </ul>
    </div>

    <script>
        const field = document.getElementById('soccerField');
        let fieldRect = field.getBoundingClientRect(); // letに変更してリサイズ対応できるようにする

        const PLAYER_SIZE = 28;
        const BALL_SIZE = 22;
        const playersData = []; 
        let ballData = {}; // ボールデータ

        const redPenaltyAreaRect = {
            x1: 0, y1: (fieldRect.height - 308) / 2,
            x2: 81, y2: (fieldRect.height - 308) / 2 + 308
        };
        const bluePenaltyAreaRect = {
            x1: fieldRect.width - 81, y1: (fieldRect.height - 308) / 2,
            x2: fieldRect.width, y2: (fieldRect.height - 308) / 2 + 308
        };

        function createPlayer(id, team, initialX, initialY, number) {
            const playerEl = document.createElement('div');
            playerEl.classList.add('player', team);
            playerEl.id = id;
            playerEl.textContent = number;
            playerEl.style.left = `${initialX}px`;
            playerEl.style.top = `${initialY}px`;
            field.appendChild(playerEl);

            const playerData = { id, team, x: initialX, y: initialY, el: playerEl, isGK: false };
            playersData.push(playerData);
            makeDraggable(playerData, PLAYER_SIZE, true); // 最後の引数はisPlayer
            return playerData;
        }

        function createBall() {
            const ballEl = document.getElementById('ball');
            const initialX = fieldRect.width / 2 - BALL_SIZE / 2;
            const initialY = fieldRect.height / 2 - BALL_SIZE / 2;
            ballEl.style.left = `${initialX}px`;
            ballEl.style.top = `${initialY}px`;
            
            ballData = { el: ballEl, x: initialX, y: initialY };
            makeDraggable(ballData, BALL_SIZE, false); // isPlayer = false
        }

        function makeDraggable(itemData, itemSize, isPlayer) {
            const itemEl = itemData.el;
            let offsetX, offsetY;

            itemEl.addEventListener('mousedown', (e) => {
                e.preventDefault();
                itemEl.classList.add('dragging');
                // fieldRectを最新の状態に更新 (ウィンドウリサイズ対応)
                fieldRect = field.getBoundingClientRect(); 
                offsetX = e.clientX - itemEl.getBoundingClientRect().left;
                offsetY = e.clientY - itemEl.getBoundingClientRect().top;

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                let newX = e.clientX - fieldRect.left - offsetX;
                let newY = e.clientY - fieldRect.top - offsetY;

                newX = Math.max(0, Math.min(newX, fieldRect.width - itemSize));
                newY = Math.max(0, Math.min(newY, fieldRect.height - itemSize));

                itemEl.style.left = `${newX}px`;
                itemEl.style.top = `${newY}px`;
                itemData.x = newX;
                itemData.y = newY;
            }

            function onMouseUp() {
                itemEl.classList.remove('dragging');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                if (isPlayer) {
                    updateAllGoalkeepers(); 
                }
            }
        }

        function isPlayerInArea(player, areaRect) {
            const playerCenterX = player.x + PLAYER_SIZE / 2;
            const playerCenterY = player.y + PLAYER_SIZE / 2;
            return playerCenterX >= areaRect.x1 && playerCenterX <= areaRect.x2 &&
                   playerCenterY >= areaRect.y1 && playerCenterY <= areaRect.y2;
        }

        function updateTeamGoalkeeper(teamColor, penaltyArea) {
            const teamPlayers = playersData.filter(p => p.team === teamColor);
            const playersInPA = teamPlayers.filter(p => isPlayerInArea(p, penaltyArea));
            
            let previousGK = teamPlayers.find(p => p.isGK);
            teamPlayers.forEach(p => p.isGK = false);

            if (playersInPA.length === 1) {
                playersInPA[0].isGK = true;
            } else if (playersInPA.length > 1) {
                if (previousGK && playersInPA.includes(previousGK)) {
                    previousGK.isGK = true; 
                } else {
                    const randomIndex = Math.floor(Math.random() * playersInPA.length);
                    playersInPA[randomIndex].isGK = true;
                }
            }
            teamPlayers.forEach(p => updatePlayerStyle(p));
        }

        function updateAllGoalkeepers() {
            // ペナルティエリアの座標もウィンドウリサイズを考慮して更新
            redPenaltyAreaRect.y1 = (fieldRect.height - 308) / 2;
            redPenaltyAreaRect.y2 = (fieldRect.height - 308) / 2 + 308;
            bluePenaltyAreaRect.y1 = (fieldRect.height - 308) / 2;
            bluePenaltyAreaRect.y2 = (fieldRect.height - 308) / 2 + 308;
            bluePenaltyAreaRect.x1 = fieldRect.width - 81; // x座標も更新
            bluePenaltyAreaRect.x2 = fieldRect.width;


            updateTeamGoalkeeper('red', redPenaltyAreaRect);
            updateTeamGoalkeeper('blue', bluePenaltyAreaRect);
        }

        function updatePlayerStyle(playerData) {
            playerData.el.classList.remove('goalkeeper');
            if (playerData.isGK) {
                playerData.el.classList.add('goalkeeper');
            }
        }

        function initializePlayers() {
            // 赤チーム (左側)
            createPlayer('r1', 'red', 50, fieldRect.height / 2 - PLAYER_SIZE / 2, 1);
            createPlayer('r2', 'red', 150, fieldRect.height / 4 - PLAYER_SIZE / 2, 2);
            createPlayer('r3', 'red', 150, fieldRect.height * 3 / 4 - PLAYER_SIZE / 2, 3);
            createPlayer('r4', 'red', 250, fieldRect.height / 2 - PLAYER_SIZE / 2, 4);
            createPlayer('r5', 'red', 200, fieldRect.height / 2 - 70, 5);

            // 青チーム (右側)
            createPlayer('b1', 'blue', fieldRect.width - 50 - PLAYER_SIZE, fieldRect.height / 2 - PLAYER_SIZE / 2, 1);
            createPlayer('b2', 'blue', fieldRect.width - 150 - PLAYER_SIZE, fieldRect.height / 4 - PLAYER_SIZE / 2, 2);
            createPlayer('b3', 'blue', fieldRect.width - 150 - PLAYER_SIZE, fieldRect.height * 3 / 4 - PLAYER_SIZE / 2, 3);
            createPlayer('b4', 'blue', fieldRect.width - 250 - PLAYER_SIZE, fieldRect.height / 2 - PLAYER_SIZE / 2, 4);
            createPlayer('b5', 'blue', fieldRect.width - 200 - PLAYER_SIZE, fieldRect.height / 2 + 40, 5);
            
            updateAllGoalkeepers();
        }

        // ダークモード切替
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // ローカルストレージに設定を保存 (オプション)
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('soccerThemePref', 'dark');
            } else {
                localStorage.setItem('soccerThemePref', 'light');
            }
        });

        // 初期化
        function initApp() {
            // 保存されたテーマ設定を読み込む (オプション)
            if (localStorage.getItem('soccerThemePref') === 'dark') {
                document.body.classList.add('dark-mode');
            }
            
            initializePlayers();
            createBall(); // ボールを作成・配置
        }
        
        // ウィンドウリサイズ時にフィールドと要素の相対位置を再計算
        window.addEventListener('resize', () => {
            fieldRect = field.getBoundingClientRect();
            // 必要であれば、ここでプレイヤーやボールの位置も再計算して調整する
            // (現在はドラッグ時に最新のfieldRectを使うので、静止時はそのままでも可)
            updateAllGoalkeepers(); // PAエリアの座標が変わる可能性があるのでGK更新
        });

        initApp();

    </script>
</body>
</html>
